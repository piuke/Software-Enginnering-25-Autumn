# GitHub Actions 工作流配置
# 工作流名称
name: Python Project CI

# 触发工作流的事件：当有代码推送到 main 分支或有人向 main 分支发起 Pull Request 时触发
on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

# 工作流包含的任务 (jobs)
jobs:
  build-and-test:
    # 运行此任务的操作系统环境
    runs-on: ubuntu-latest
    
    # 策略：使用多个Python版本测试
    strategy:
      matrix:
        python-version: ['3.8', '3.9', '3.10', '3.11', '3.12']

    # 任务包含的步骤 (steps)
    steps:
    # 第一步：检出代码库
    - name: Checkout repository
      uses: actions/checkout@v4

    # 第二步：设置Python环境
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}

    # 第三步：缓存pip依赖（提高构建速度）
    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    # 第四步：安装项目依赖
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r exp3/requirements.txt
        pip install pytest pytest-cov pylint

    # 第五步：代码质量检查（Pylint）
    - name: Lint with pylint
      run: |
        # 对 models, services, utils 目录进行代码检查
        pylint exp3/models/ --fail-under=5.0 --disable=missing-module-docstring,missing-class-docstring,missing-function-docstring || true
        pylint exp3/services/ --fail-under=5.0 --disable=missing-module-docstring,missing-class-docstring,missing-function-docstring || true
        pylint exp3/utils/ --fail-under=5.0 --disable=missing-module-docstring,missing-class-docstring,missing-function-docstring || true
      continue-on-error: true

    # 第六步：运行单元测试（使用pytest）
    - name: Run unit tests with pytest
      run: |
        cd exp3
        pytest tests/ -v --tb=short --cov=. --cov-report=xml --cov-report=html 2>/dev/null || pytest tests/ -v --tb=short

    # 第七步：运行集成测试脚本
    - name: Run integration tests
      run: |
        cd exp3
        # 运行主要脚本的测试
        python scripts/smoke_test_orders.py || true
        python scripts/test_refund_flow.py || true
        python scripts/test_cancel_approval.py || true

    # 第八步：上传代码覆盖率报告到Codecov（可选）
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: ./exp3/coverage.xml
        flags: unittests
        name: codecov-umbrella
      continue-on-error: true

    # 第九步：生成测试摘要
    - name: Test Summary
      if: always()
      run: |
        echo "✅ 工作流执行完成"
        echo "Python 版本: ${{ matrix.python-version }}"
        echo "操作系统: ${{ runner.os }}"
